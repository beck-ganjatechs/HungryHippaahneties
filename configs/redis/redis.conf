# HungryHippaahneties - Redis HIPAA-Compliant Configuration
# Based on OWASP Security Best Practices

# ===========================================
# NETWORK CONFIGURATION
# ===========================================
# Bind only to localhost and pod network interface
bind 127.0.0.1 -::1
port 6379

# Protected mode - require authentication
protected-mode yes

# TCP keepalive
tcp-keepalive 300

# ===========================================
# TLS/SSL CONFIGURATION - OWASP TLS Best Practices
# ===========================================
tls-port 6380
port 0  # Disable non-TLS port

# TLS certificates
tls-cert-file /etc/redis/ssl/redis.crt
tls-key-file /etc/redis/ssl/redis.key
tls-ca-cert-file /etc/redis/ssl/ca.crt

# Require client certificate verification
tls-auth-clients yes

# TLS protocol versions (TLS 1.2 minimum as per OWASP)
tls-protocols "TLSv1.2 TLSv1.3"

# Strong cipher suites only
tls-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
tls-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305

# Prefer server ciphers
tls-prefer-server-ciphers yes

# ===========================================
# AUTHENTICATION - OWASP: Strong Authentication
# ===========================================
# ACL configuration - use ACL file for user management
aclfile /etc/redis/users.acl

# Require password (this is the default user, prefer ACL)
# requirepass will be set via K8s secret

# ===========================================
# MEMORY MANAGEMENT
# ===========================================
maxmemory 256mb
maxmemory-policy allkeys-lru

# ===========================================
# PERSISTENCE - Data Protection
# ===========================================
# RDB snapshots
save 900 1
save 300 10
save 60 10000

dbfilename dump.rdb
dir /data

# Enable RDB checksum
rdbchecksum yes

# AOF persistence for better durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ===========================================
# LOGGING - HIPAA Audit Requirements
# ===========================================
loglevel notice
logfile /var/log/redis/redis.log

# Log slow queries
slowlog-log-slower-than 10000
slowlog-max-len 128

# ===========================================
# SECURITY HARDENING
# ===========================================
# Rename dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "HIPAA_CONFIG_a1b2c3d4"
rename-command SHUTDOWN "HIPAA_SHUTDOWN_e5f6g7h8"
rename-command SLAVEOF ""
rename-command REPLICAOF ""
rename-command MIGRATE ""
rename-command RESTORE ""
rename-command CLUSTER ""
rename-command MODULE ""
rename-command EVAL ""
rename-command EVALSHA ""
rename-command SCRIPT ""
rename-command BGSAVE "HIPAA_BGSAVE_i9j0k1l2"
rename-command BGREWRITEAOF "HIPAA_BGREWRITEAOF_m3n4o5p6"

# Disable Lua scripting (prevent injection)
# lua-time-limit 0

# ===========================================
# CLIENT LIMITS
# ===========================================
maxclients 100
timeout 300

# ===========================================
# REPLICATION (for HA)
# ===========================================
# replica-read-only yes
# replica-serve-stale-data yes

# ===========================================
# CLUSTER (if using Redis Cluster)
# ===========================================
# cluster-enabled no
