# HungryHippaahneties - PostgreSQL HIPAA-Compliant Configuration
# Based on OWASP Database Security Cheat Sheet

# ===========================================
# CONNECTION SETTINGS
# ===========================================
listen_addresses = 'localhost'  # Only localhost - use K8s service for external
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# ===========================================
# AUTHENTICATION - OWASP: Strong Authentication
# ===========================================
password_encryption = scram-sha-256  # Modern password hashing
authentication_timeout = 60s

# ===========================================
# SSL/TLS CONFIGURATION - OWASP TLS Best Practices
# ===========================================
ssl = on
ssl_cert_file = '/var/lib/postgresql/ssl/server.crt'
ssl_key_file = '/var/lib/postgresql/ssl/server.key'
ssl_ca_file = '/var/lib/postgresql/ssl/ca.crt'
ssl_crl_file = ''
ssl_prefer_server_ciphers = on
ssl_ciphers = 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256'
ssl_min_protocol_version = 'TLSv1.2'

# ===========================================
# MEMORY SETTINGS
# ===========================================
shared_buffers = 256MB
effective_cache_size = 768MB
maintenance_work_mem = 128MB
work_mem = 4MB

# ===========================================
# WRITE AHEAD LOG (WAL) - Data Integrity
# ===========================================
wal_level = replica
fsync = on
synchronous_commit = on
wal_sync_method = fdatasync
full_page_writes = on
wal_compression = on
wal_buffers = 16MB
checkpoint_completion_target = 0.9

# ===========================================
# REPLICATION (for HA setups)
# ===========================================
max_wal_senders = 5
max_replication_slots = 5

# ===========================================
# LOGGING - HIPAA Audit Trail Requirements
# ===========================================
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = off

# Log format with timestamp and session info
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

# What to log - HIPAA requires comprehensive audit logging
log_connections = on
log_disconnections = on
log_duration = on
log_statement = 'all'  # Log all SQL statements for HIPAA audit
log_error_verbosity = default
log_hostname = on

# Log slow queries for performance analysis
log_min_duration_statement = 1000  # Log queries taking > 1 second

# Log checkpoints and autovacuum
log_checkpoints = on
log_autovacuum_min_duration = 0
log_lock_waits = on

# ===========================================
# PGAUDIT EXTENSION - Enhanced Audit Logging for HIPAA
# ===========================================
# shared_preload_libraries = 'pgaudit'
# pgaudit.log = 'all'
# pgaudit.log_catalog = on
# pgaudit.log_client = on
# pgaudit.log_level = 'log'
# pgaudit.log_parameter = on
# pgaudit.log_relation = on
# pgaudit.log_statement_once = off

# ===========================================
# ROW LEVEL SECURITY - HIPAA Access Control
# ===========================================
# Enable row-level security policies
row_security = on

# ===========================================
# SECURITY SETTINGS
# ===========================================
# Prevent excessive resource usage
statement_timeout = 60000  # 60 seconds max query time
lock_timeout = 30000  # 30 seconds max lock wait
idle_in_transaction_session_timeout = 300000  # 5 minutes

# Limit temporary file usage
temp_file_limit = 1GB

# ===========================================
# CLIENT CONNECTION DEFAULTS
# ===========================================
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# ===========================================
# QUERY TUNING
# ===========================================
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

# ===========================================
# AUTOVACUUM SETTINGS
# ===========================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
