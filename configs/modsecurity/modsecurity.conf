# HungryHippaahneties - ModSecurity WAF Configuration
# OWASP Core Rule Set (CRS) Integration for HIPAA Compliance

# ===========================================
# MAIN CONFIGURATION
# ===========================================
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json

# ===========================================
# REQUEST BODY HANDLING
# ===========================================
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# ===========================================
# RESPONSE BODY HANDLING
# ===========================================
SecResponseBodyLimit 1048576
SecResponseBodyLimitAction ProcessPartial

# ===========================================
# TEMPORARY FILES
# ===========================================
SecTmpDir /tmp/
SecDataDir /tmp/

# ===========================================
# AUDIT LOGGING - HIPAA Compliance
# ===========================================
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/modsec_audit.log

# ===========================================
# DEBUG LOGGING (disable in production)
# ===========================================
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 0

# ===========================================
# RULE ENGINE SETTINGS
# ===========================================
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127
SecStatusEngine On

# ===========================================
# OWASP CRS PARANOIA LEVEL
# Level 1: Basic protection
# Level 2: Recommended for most sites
# Level 3: High security (may cause false positives)
# Level 4: Maximum security (high false positive rate)
# ===========================================
SecAction \
    "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.paranoia_level=2"

# ===========================================
# ANOMALY SCORING MODE
# ===========================================
SecAction \
    "id:900110,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.inbound_anomaly_score_threshold=5,\
    setvar:tx.outbound_anomaly_score_threshold=4"

# ===========================================
# SQL INJECTION PROTECTION - OWASP A03:2021
# ===========================================
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@detectSQLi" \
    "id:942100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,\
    msg:'SQL Injection Attack Detected via libinjection',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-sqli',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    tag:'capec/1000/152/248/66',\
    tag:'PCI/6.5.2',\
    severity:'CRITICAL',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# ===========================================
# XSS PROTECTION - OWASP A03:2021
# ===========================================
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|REQUEST_HEADERS:User-Agent|REQUEST_HEADERS:Referer|ARGS_NAMES|ARGS|XML:/* "@detectXSS" \
    "id:941100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls,\
    msg:'XSS Attack Detected via libinjection',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xss',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    tag:'capec/1000/152/242',\
    severity:'CRITICAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# ===========================================
# REMOTE FILE INCLUSION (RFI) PROTECTION
# ===========================================
SecRule ARGS "@rx (?i)(?:file|dict|ftp|gopher|ldap|ssh2?|php|data|glob|expect|phar):\/\/" \
    "id:931100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
    msg:'Possible Remote File Inclusion (RFI) Attack',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-rfi',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL',\
    setvar:'tx.rfi_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# ===========================================
# LOCAL FILE INCLUSION (LFI) PROTECTION
# ===========================================
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|XML:/*|!REQUEST_HEADERS:Referer "@rx (?i)(?:(?:^|[\\/])\.\.[\\/]|[\\/]\.\.(?:[\\/]|$))" \
    "id:930100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:urlDecodeUni,\
    msg:'Path Traversal Attack (/../)',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-lfi',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL',\
    setvar:'tx.lfi_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# ===========================================
# COMMAND INJECTION PROTECTION - OWASP A03:2021
# ===========================================
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/*|XML://@* \
    "@rx (?i)(?:;|\||`|&&|\|\||\\$\(|\\$\{)" \
    "id:932100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:urlDecodeUni,t:cmdLine,\
    msg:'Remote Command Execution: Unix Command Injection',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-shell',\
    tag:'platform-unix',\
    tag:'attack-rce',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL',\
    setvar:'tx.rce_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# ===========================================
# HTTP PROTOCOL VIOLATIONS
# ===========================================
SecRule REQUEST_HEADERS:Content-Type "^(?i:application/x-www-form-urlencoded)(?![\r\n\t ;]|$)" \
    "id:920420,\
    phase:1,\
    block,\
    t:none,\
    msg:'Request content type is not allowed by policy',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-protocol',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

# ===========================================
# SCANNER/BOT DETECTION
# ===========================================
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile scanners-user-agents.data" \
    "id:913100,\
    phase:1,\
    block,\
    capture,\
    t:none,t:lowercase,\
    msg:'Found User-Agent associated with security scanner',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-reputation-scanner',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

# ===========================================
# SENSITIVE DATA LEAKAGE PREVENTION (HIPAA)
# Block responses containing potential PHI patterns
# ===========================================
SecRule RESPONSE_BODY "@rx (?i)(?:\d{3}-\d{2}-\d{4})" \
    "id:950001,\
    phase:4,\
    block,\
    t:none,\
    msg:'Potential SSN Leakage Detected in Response',\
    tag:'HIPAA',\
    tag:'data-leakage',\
    severity:'CRITICAL'"

SecRule RESPONSE_BODY "@rx (?i)(?:patient[_\s]?(?:id|name|dob|ssn|address)|medical[_\s]?record|diagnosis|prescription)" \
    "id:950002,\
    phase:4,\
    log,\
    pass,\
    t:none,t:lowercase,\
    msg:'Potential PHI Keywords Detected in Response - Review Required',\
    tag:'HIPAA',\
    tag:'data-leakage',\
    severity:'WARNING'"

# ===========================================
# REQUEST METHOD RESTRICTIONS
# ===========================================
SecRule REQUEST_METHOD "!@within GET HEAD POST PUT DELETE OPTIONS PATCH" \
    "id:911100,\
    phase:1,\
    block,\
    t:none,\
    msg:'Method is not allowed by policy',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-generic',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

# ===========================================
# IP REPUTATION (Placeholder for IP blacklist)
# ===========================================
# SecRule REMOTE_ADDR "@ipMatchFromFile ip-blacklist.data" \
#     "id:910000,\
#     phase:1,\
#     deny,\
#     msg:'Request from blacklisted IP Address',\
#     tag:'application-multi',\
#     tag:'language-multi',\
#     tag:'platform-multi',\
#     tag:'attack-reputation-ip',\
#     severity:'CRITICAL'"

# ===========================================
# INCLUDE OWASP CRS RULES
# ===========================================
Include /etc/modsecurity/crs/crs-setup.conf
Include /etc/modsecurity/crs/rules/*.conf
